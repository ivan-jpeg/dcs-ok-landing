# Функциональная спецификация: ok-landing.lua

Контекст для работы с кодом утилиты измерения максимальной перегрузки при посадке в DCS. Версия кода: **v3.0 (stable)**.

---

## 1. Назначение

- **Скрипт:** `ok-landing/ok-landing.lua`
- **Среда:** DCS World, Mission Scripting (DO SCRIPT FILE в миссии). Не Export, не мод.
- **Функция:** измерение текущей и максимальной вертикальной перегрузки **по оси Y в связанной (бортовой) СК** самолёта игрока, вывод в сообщении DCS, автозапуск/автостоп по высоте над землёй (AGL) 100 м.

---

## 2. Пользовательский интерфейс

- **Радио-меню F10 → Other:**
  - **Старт измерения** — включить измерение, показать сообщение с Ny и Ny(max).
  - **Сброс измерения** — обнулить только Ny(max); текущее Ny продолжает считаться.
  - **Стоп измерения** — выключить измерение, скрыть сообщение.

- **Сообщение (формат строго):**
  ```
  Ny = X.XX
  Ny(max) = X.XX
  ```
  Числа с двумя знаками после запятой. Сообщение обновляется с интервалом UPDATE_INTERVAL (0.1 с), пока идёт измерение.

- **Автозапуск:** при первом снижении ниже 100 м AGL измерение включается автоматически.
- **Автоостановка:** при наборе высоты выше 100 м AGL измерение выключается, состояние полностью сбрасывается.

---

## 3. Структура файла и блоки кода

| Секция в файле | Содержимое |
|----------------|------------|
| Константы и глобальное состояние | `G`, `AGL_THRESHOLD`, `POLL_INTERVAL`, `UPDATE_INTERVAL`; таблицы `stateByGroup`, `menuAddedForGroups`; счётчики таймера |
| Форматирование и AGL | `formatMessage(currentNy, maxNy)`, `getAGL(unit)` |
| Сброс и меню | `fullReset(s)`, `addMenuForGroup(group)` + обработчики onStart/onReset/onStop |
| Опрос игроков | `pollPlayerGroups()`, `getUnitFromGroup(groupName)` |
| Расчёт Ny | `computeNyBodyY(velNow, velPrev, dt, bodyY)` |
| Обновление по группам | `updateNyAndMessage(t)` — AGL, автостарт/стоп, расчёт Ny, обновление сообщения |
| Планировщик | `scheduler(_args, t)`, запуск через `timer.scheduleFunction(scheduler, {}, timer.getTime() + 1)` |

---

## 4. Данные и состояние

- **stateByGroup[groupId]** — состояние по группе игрока:
  - `currentNy`, `maxNy` — текущая и максимальная перегрузка;
  - `measuring` — идёт ли измерение;
  - `showMessage` — нужно ли показывать сообщение;
  - `prevVel`, `prevTime` — предыдущая скорость и время для численного дифференцирования;
  - `lastAGL` — последняя высота над землёй (для порога 100 м);
  - `groupName` — имя группы (для получения юнита через Group.getByName).

- **menuAddedForGroups[groupId]** — флаг, что меню для группы уже добавлено (не дублировать пункты).

- **nextPollTime, nextUpdateTime** — время следующего опроса групп и следующего обновления Ny/сообщений.

---

## 5. Ключевые формулы и API

### 5.1. Перегрузка Ny по оси Y самолёта

- **Смысл:** перегрузка по бортовой оси Y (вверх по самолёту), а не по мировой вертикали. При крене ось Y наклонена, поэтому формула должна учитывать проекцию гравитации на эту ось.

- **Используемые данные DCS:**
  - `Unit.getVelocity()` — скорость в **мировой** СК (м/с).
  - `Unit.getPosition().y` — единичный вектор «вверх» самолёта в мировой СК (body Y axis).

- **Вычисление:**
  1. Ускорение в мировой СК: `a_world = (velNow - velPrev) / dt`.
  2. Проекция на ось Y самолёта: `aBodyY = dot(a_world, bodyY)`.
  3. **Ny = bodyY.y + aBodyY / G**

  Здесь `bodyY.y` — проекция гравитации (1g вверх в мировой СК) на ось Y самолёта; при горизонтальном полёте bodyY.y ≈ 1, при крене < 1. Константа `G = 9.81` м/с².

### 5.2. Высота над землёй (AGL)

- **AGL** = `Unit.getPosition().p.y` − `land.getHeight({ x = pos.p.x, y = pos.p.z })`
- Порог: **100 м** (AGL_THRESHOLD). Переход снизу вверх через 100 м → автостоп и полный сброс. Переход сверху вниз через 100 м → автозапуск.

---

## 6. Используемые API DCS (Mission Scripting)

- **Единицы и группы:** `coalition.getPlayers(coalitionId)`, `unit:getGroup()`, `Group.getByName(name)`, `group:getUnit(1)`, `unit:isExist()`, `unit:getPosition()`, `unit:getVelocity()`.
- **Позиция и рельеф:** `getPosition().p` (Vec3), `getPosition().x/.y/.z` (оси самолёта), `land.getHeight({ x, y })` (y в аргументе — координата z карты).
- **Меню и сообщения:** `missionCommands.addCommandForGroup(groupId, "Текст", nil, callback, groupInfo)`, `trigger.action.outTextForGroup(groupId, text, duration, clearView)`.
- **Таймер:** `timer.getTime()`, `timer.scheduleFunction(func, args, nextTime)` — функция возвращает время следующего вызова (`t + 0.1`).

Ограничения Mission Scripting: нет доступа к `io`, `os`; доступен `timer`, `env.info()` для лога.

---

## 7. Поведение по сценариям

- **Несколько игроков:** у каждой группы свой state в stateByGroup, своё меню, свои Ny/maxNy.
- **Ручной старт выше 100 м:** измерение идёт, автостоп сработает при наборе высоты выше 100 м AGL.
- **Сброс:** только maxNy устанавливается в текущий currentNy (или 1, если currentNy ≤ 1); текущее Ny не обнуляется.
- **Ошибки:** при ошибке в `updateNyAndMessage` вызывается `env.info("[ok-landing] updateNyAndMessage error: ...")`, планировщик продолжает работу.

---

## 8. Где что менять

| Задача | Место в коде |
|--------|----------------|
| Порог AGL (100 м) | Константа `AGL_THRESHOLD` |
| Интервал обновления сообщения | Константа `UPDATE_INTERVAL` |
| Интервал опроса групп игроков | Константа `POLL_INTERVAL` |
| Формат текста сообщения | Функция `formatMessage` |
| Логика расчёта Ny | Функция `computeNyBodyY` (и константа `G`) |
| Текст пунктов меню | Строки в `missionCommands.addCommandForGroup` |
| Условия автостарта/автостопа | Блок в `updateNyAndMessage` с `s.lastAGL`, `AGL_THRESHOLD` |

---

## 9. Версия и стабильность

- **Текущая версия:** v3.0 (stable).
- Стабильная ветка: расчёт Ny по формуле `bodyY.y + aBodyY/G`, без диагностического/отладочного кода; комментарии к блокам приведены в самом файле.
